<!DOCTYPE html>
<html lang="en">
<head>
	<title>Kernel &mdash; Matteo Salonia</title>

	<!-- Optimize page loading -->
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<!-- SEO -->
	<meta name="description"				content="Salonia Matteo's custom Kernel.">
	<meta property="og:description"			content="Salonia Matteo's custom Kernel.">
	<meta property="twitter:description"	content="Salonia Matteo's custom Kernel.">
	<meta property="og:title"				content="Kernel &mdash; Matteo Salonia">
	<meta property="twitter:title"			content="Kernel &mdash; Matteo Salonia">
	<meta property="og:url"					content="https://salonia.it/en/kernel.html">
	<meta property="og:image"				content="https://salonia.it/favicon.png">
	<meta property="twitter:image"			content="https://salonia.it/favicon.png">

	<!-- Favicon -->
	<link rel="shortcut icon" href="../favicon.png">

	<!-- CSS & Fonts -->
	<link rel="stylesheet" href="../css/cirrus.min.css">
	<link rel="stylesheet" href="../css/fonts/nunito-sans.css">
	<link rel="stylesheet" href="../css/fonts/montserrat.css">
</head>

<body>
	<!-- Header -->
	<div class="header header-fixed unselectable">
		<div class="header-brand u-center">
			<a href="https://salonia.it">
				<img class="w-24" src="../pics/salonia.png">
			</a>
		</div>
	</div>

	<!-- Kernel -->
	<div class="hero u-text-center u-shadow-inset pt-8">
		<div class="hero-body m-2-sm">
			<div class="content w-90p w-80p-md">
			<h2 class="headline-4 text-gray-900">Kernel</h2>
				<p class="lead">
					This page contains all the details necessary to use my script
					to configure the Linux Kernel, optimizing it to
					maximize the hardware's performance, and be as light as possible.
				</p>

				<p>
				Go to:<br>
				<a class="tag bg-blue-700 text-white" href="#intro">Introduction</a>
				<a class="tag bg-blue-700 text-white" href="#setup">Setup</a>
				<a class="tag bg-blue-700 text-white" href="#extra">Extra</a>
				</p>

				<div class="content u-text-left">
					<div class="card">
						<div class="m-3">
							<!-- Intro -->
							<h3 class="tag tag--xl bg-blue-700 my-0" id="intro">
								<a class="text-white" href="#intro">Introduction</a>
							</h3>

							<p>
							This project was realized and is maintained to be a "tool",
							in order to help me configure the Kernel as I please,
							allowing me to also apply patches in order to make it more efficient
							and performant, optimizing it for the available hardware, in the slightest detail.
							</p>

							<p>
							My setups are based on a system comprised of the following components:
							<ul>
								<li><b>Distro</b>: <a class="link u u-LR" href="https://gentoo.org">Gentoo Linux</a></li>
								<li><b>Kernel compression</b>: LZ4 for the initramfs, zstd for modules</li>
								<li><b>Initramfs</b>: <a class="link u u-LR" href="https://github.com/dracutdevs/dracut">dracut</a></li>
								<li><b>Bootloader</b>: <a class="link u u-LR" href="https://www.gnu.org/software/grub/">GRUB</a></li>
								<li><b>Init</b>: <a class="link u u-LR" href="https://github.com/OpenRC/openrc">OpenRC</a></li>
								<li><b>Filesystem</b>:
									FAT32 for the <a class="link u u-LR" href="https://en.wikipedia.org/wiki/EFI_system_partition">ESP</a>,
									XFS for the <a class="link u u-LR" href="https://www.kernel.org/doc/html/latest/filesystems/ramfs-rootfs-initramfs.html#what-is-rootfs">rootfs</a>,
									ext4 for various things.</li>
								<li><b>logind</b>: <a class="link u u-LR" href="https://wiki.gentoo.org/wiki/Elogind">elogind</a></li>
							</ul>
							</p>

							<div class="card bg-warning">
								<p class="m-3">
								<b>N.B.</b>: since I use <b>Gentoo</b>, the package names may vary from your distro's
								(Arch, Debian, Fedora, ...) packages. Please verify whether the names may vary, and take note of them.
								</p>
							</div>

							<p>
							There are two default configs:
							<ol>
								<li>
									<code>config</code>: for my <b>ThinkPad T440p</b>, with CPU <b>i7-4700MQ</b>, no GPU (iGPU),
									<b>8GB RAM</b>, SSD M.2 2242 + SSD SATAIII.
								</li>
								<li>
									<code>config.pc</code>: for my desktop PC, with CPU <b>i5-11400MQ</b>, no GPU (iGPU),
									<b>16GB RAM</b>, SSD NVME Samsung 980 Pro</b>.
								</li>
							</ol>
							</p>

							<p>
							Since the changes made to the Kernel config, it'll be necessary to verify the
							desired components are enabled in the Kernel, whenever you'd choose my config
							as a starting point. For example, components relative to AMD, Nvidia, NUMA, etc. have been disabled.
							<br>
							If you don't know where to start, use an already existing config that you know works on your hardware,
							if available, or else use any Kernel's default config, like that provided by your distro,
							or the Kernel's very own default config.
							</p>
						</div>
					</div>

					<div class="card">
						<div class="m-3">
							<h3 class="tag tag--xl bg-blue-700 my-0" id="setup">
								<a class="text-white" href="#setup">Setup</a>
							</h3>

							<p>
							Make sure to have all the tools necessary to proceed.
							Verify you have <code>git</code>, <code>gcc</code>, <code>make</code>, etc.
							Tipically, most compilation tools are provided by packages like <code>base-devel</code>.
							I suggest you also verify the presence of <code>linux-firmware</code>,
							in order to have the necessary firmware for any
							<a class="link u u-LR" href="https://www.gnu.org/philosophy/free-hardware-designs.html">nonfree</a> hardware.
							Don't forget to download the <a class="link u u-LR" href="https://wiki.gentoo.org/wiki/Microcode">microcode</a>
							that is most appropriate, whether it be Intel, AMD, or any other.
							Finally, make sure you have <code>lz4</code> and <code>zstd</code>,
							in order to compress various Kernel components.
							</p>

							<div class="divider"></div>

							<h4 class="tag tag--md bg-blue-700 mb-0" id="s1">
								<a class="text-white" href="#s1">1. Get the repository</a>
							</h4>

							<p>
							We'll use the <code>/usr/src/usr-kernel</code> directory in order to save this project.
							Make sure you have read and write permissions, in order to create the directory.
							</p>

							<pre><code>git clone --recurse-submodules "https://github.com/saloniamatteo/kernel" /usr/src/usr-kernel
cd /usr/src/usr-kernel</code></pre>

							<br>

							<div class="card bg-info text-white">
								<p class="m-3">
								Whenever the chosen directory differs from the default,
								don't forget to modify the <code>CUSTDIR</code> variable in <code>build.sh</code>.
								</p>
							</div>

							<div class="divider"></div>

							<h4 class="tag tag--md bg-blue-700 mb-0" id="s2">
								<a class="text-white" href="#s2">2. Version selection</a>
							</h4>

							<p>
							Once you get the repository, choose an available version.
							To see which version is available, you just need to list
							the directory contents with <code>ls</code>.
							In this example, we'll use Linux <code>6.8.2-gentoo</code>.
							</p>

							<div class="card bg-info text-white">
								<p class="m-3">
								Your Kernel will surely have a different version.
								<br>
								Don't panic: you just need to copy the folder, and rename it according
								to your version. For example, if your version would be <code>6.8.3-zen</code>,
								you just need to execute: <code>cp -r 6.8.2-gentoo 6.8.3-zen</code>.
								<br>
								Don't forget to modify the <code>KVER</code> variable whenever the primary version
								differs (e.g.: <code>6.8.2</code> -> <code>6.8.3</code>), and
								<code>PVER</code> whenever the secondary/custom version differs
								(e.g.: <code>gentoo</code> -> <code>zen</code>)
								</p>
							</div>

							<div class="divider"></div>

							<h4 class="tag tag--md bg-blue-700 mb-0" id="s3">
								<a class="text-white" href="#s3">3. Modify the script</a>
							</h4>

							<p>
							Now, we need to verify the contents of <code>build.sh</code>.
							Modify the file with any text editor, and note the following variables:

							<ul>
								<li>
									<code>ARCHVER</code>: CPU architecture code, to optimize the Kernel.
									Here is the full list of codes:
									<pre class="my-2"><code> 1. AMD Opteron/Athlon64/Hammer/K8 (MK8)
 2. AMD Opteron/Athlon64/Hammer/K8 with SSE3 (MK8SSE3)
 3. AMD 61xx/7x50/PhenomX3/X4/II/K10 (MK10)
 4. AMD Barcelona (MBARCELONA)
 5. AMD Bobcat (MBOBCAT)
 6. AMD Jaguar (MJAGUAR)
 7. AMD Bulldozer (MBULLDOZER)
 8. AMD Piledriver (MPILEDRIVER)
 9. AMD Steamroller (MSTEAMROLLER)
10. AMD Excavator (MEXCAVATOR)
11. AMD Zen (MZEN)
12. AMD Zen 2 (MZEN2)
13. AMD Zen 3 (MZEN3)
14. AMD Zen 4 (MZEN4)
15. Intel P4 / older Netburst based Xeon (MPSC)
16. Intel Core 2 (MCORE2)
17. Intel Atom (MATOM)
18. Intel Nehalem (MNEHALEM)
19. Intel Westmere (MWESTMERE)
20. Intel Silvermont (MSILVERMONT)
21. Intel Goldmont (MGOLDMONT)
22. Intel Goldmont Plus (MGOLDMONTPLUS)
23. Intel Sandy Bridge (MSANDYBRIDGE)
24. Intel Ivy Bridge (MIVYBRIDGE)
25. Intel Haswell (MHASWELL)
26. Intel Broadwell (MBROADWELL)
27. Intel Skylake (MSKYLAKE)
28. Intel Skylake X (MSKYLAKEX)
29. Intel Cannon Lake (MCANNONLAKE)
30. Intel Ice Lake (MICELAKE)
31. Intel Cascade Lake (MCASCADELAKE)
32. Intel Cooper Lake (MCOOPERLAKE)
33. Intel Tiger Lake (MTIGERLAKE)
34. Intel Sapphire Rapids (MSAPPHIRERAPIDS)
35. Intel Rocket Lake (MROCKETLAKE)
36. Intel Alder Lake (MALDERLAKE)
37. Intel Raptor Lake (MRAPTORLAKE)
38. Intel Meteor Lake (MMETEORLAKE)
39. Intel Emerald Rapids (MEMERALDRAPIDS)
40. Generic-x86-64 (GENERIC_CPU)
41. Generic-x86-64-v2 (GENERIC_CPU2)
42. Generic-x86-64-v3 (GENERIC_CPU3)
43. Generic-x86-64-v4 (GENERIC_CPU4)
44. Intel-Native optimizations autodetected by GCC (MNATIVE_INTEL)
45. AMD-Native optimizations autodetected by GCC (MNATIVE_AMD)</code></pre>
								</li>
								<li><code>CONFIGFILE</code>: config file name, that will be copied from the directory to the Kernel.</li>
								<li><code>JOBS</code>: how many threads to use for the compilation. I recommend setting the number of cores.</li>
								<li><code>KVER</code>: primary Kernel version.</li>
								<li><code>PVER</code>: secondary/custom Kernel version.</li>
								<li><code>KERNVER</code>: full Kernel version, <u>do not modify</u>.</li>
								<li><code>CUSTDIR</code>: this project's directory, modify whenever it differs from the defaults.</li>
								<li><code>CLEARDIR</code>: Clear Linux directory name, <u>do not modify</u>.</li>
								<li><code>PATCHDIR</code>: patch directory name, <u>do not modify</u>.</li>
								<li><code>V4L2DIR</code>: V4L2loopback directory name, <u>do not modify</u>.</li>
								<li><code>CFODIR</code>: Kernel Compiler Patch directory name, <u>do not modify</u>.</li>
								<li><code>USRDIR</code>: chosen Kernel version directory name, <u>do not modify</u>.</li>
								<li><code>KERNELDIR</code>: set this variable whenever the Kernel directory differs from <code>/usr/src</code>.</li>
							</ul>
							</p>

							<div class="divider"></div>

							<h4 class="tag tag--md bg-blue-700 mb-0" id="s4">
								<a class="text-white" href="#s4">4. Flag selection</a>
							</h4>

							<p>
							After modifying <code>build.sh</code>, we have to set the correct parameters
							in order to decide what to do.
							<br>
							Here's a table with all the parameters (flags).
							</p>

							<div class="table-container">
								<table class="table bordered striped">
									<thead class="bg-blue-700 text-white">
										<tr>
											<th>Short flag</th>
											<th>Long flag</th>
											<th class="u-align-middle">Description</th>
										</tr>
									</thead>
									
									<tbody>
										<tr>
											<td>-b</td>
											<td>--skip-build</td>
											<td>Skip Kernel compilation.</td>
										</tr>
										<tr>
											<td>-c</td>
											<td>--skip-cfg</td>
											<td>Do not copy the Kernel config file (<code>config</code>).</td>
										</tr>
										<tr>
											<td>-d</td>
											<td>--distcc</td>
											<td>
												Use <a class="link u u-LR" href="https://www.distcc.org">distcc</a>
												to speed up Kernel compilation
											</td>
										</tr>
										<tr>
											<td>-e</td>
											<td>--ccache</td>
											<td>
												Use <a class="link u u-LR" href="https://ccache.dev">ccache</a>
												to speed up Kernel compilation
											</td>
										</tr>
										<tr>
											<td>-f</td>
											<td>--fastmath</td>
											<td>Compile the Kernel with unsafe fast math options.</td>
										</tr>
										<tr>
											<td>-h</td>
											<td>--help</td>
											<td>Show the help menu and exit.</td>
										</tr>
										<tr>
											<td>-l</td>
											<td>--clearl-ps</td>
											<td>Apply Clear Linux patches.</td>
										</tr>
										<tr>
											<td>-m</td>
											<td>--menuconfig</td>
											<td>Execute <code>make menuconfig</code> in the Kernel directory and exit without compiling.</td>
										</tr>
										<tr>
											<td>-o</td>
											<td>--cpu-opts</td>
											<td>Compile the Kernel with CPU family optimizations.</td>
										</tr>
										<tr>
											<td>-p</td>
											<td>--patches</td>
											<td>Apply user patches.</td>
										</tr>
										<tr>
											<td>-v</td>
											<td>--v4l2</td>
											<td>Compile the <a class="link u u-LR" href="https://github.com/umlaeute/v4l2loopback">v4l2loopback</a> module.</td>
										</tr>
									</tbody>
								</table>
							</div>

							<div class="divider"></div>

							<h4 class="tag tag--md bg-blue-700 mb-0" id="s5">
								<a class="text-white" href="#s5">5. Kernel configuration</a>
							</h4>

							<p>
							Tipically, it'll be necessary to configure the Kernel, starting from a config file.
							To do so, you need to run the following as root:

							<pre class="mb-2"><code>./build.sh -l -m -o -p</pre></code>

							This will allow us to:

							<ul>
								<li><code>-l</code>: Apply Clear Linux patches</li>
								<li><code>-m</code>: Configure the Kernel, starting from an existing config,
								or load a custom config file</li>
								<li><code>-o</code>: Apply the CPU family optimization patches</li>
								<li><code>-p</code>: Apply user patches</li>
							</ul>

							Once the Kernel config process is done, the new config file will be available as <code>/usr/src/linux/.config</code>
							(or under <code>$KERNELDIR/.config</code> whenever <code>KERNELDIR</code> would've been set).
							</p>

							<p>
							Now we need to copy <code>.config</code> from the Kernel directory
							to the current directory, to then compare the two files and see any changes.

							<pre><code>cp /usr/src/linux/.config config.new<br>diff -u config config.new | vim</code></pre>

							The last command above executes the <code>diff</code> command, showing the differences
							between our starting <code>config</code> file, and the new <code>config.new</code> file,
							to then show everything with the Vim editor. Obviously, it's necessary to modify the
							name of the <code>config</code> file in the command above whenever appropriate.
							</p>

							<p>
							After verifying the differences, let's replace our config file with
							the <code>config.new</code> file, and move on to the actual Kernel compilation.
							</p>

							<div class="divider"></div>

							<h4 class="tag tag--md bg-blue-700 mb-0" id="s6">
								<a class="text-white" href="#s6">6. Kernel compilation</a>
							</h4>

							<p>
							After making sure we have everything that's necessary, 
							we can proceed with compiling the Kernel with the following command, executing it as root:

							<pre class="mb-2"><code>./build.sh -f -l -o -p</code></pre>

							Note the repeated presence of the patch options (<code>-l</code>, <code>-o</code>, <code>-p</code>).
							This is because the script automatically reverts all changes made by the patches present
							in the Kernel directory, where possible, and removes said patches.
							I programmed the script this way because I often have to revert and remove various patches,
							especially after multiple compilations.
							</p>

							<p>
							It's good to specify the script will show any compilation error, as well as showing
							the true compilation time, not considering patches and so on.
							</p>

							<p>
							Once the script finishes its execution, it'll install the Kernel,
							automatially executing <code>dracut</code> to generate the initramfs,
							and it'll update <code>grub</code>, thanks to <code>installkernel</code>,
							which most distros tipically have. If your setup does not use dracut
							nor grub, check your installkernel config, it'll be set up to use
							whatever you're currently using.
							</p>
						</div>
					</div>

					<div class="card">
						<div class="m-3">
							<h3 class="tag tag--xl bg-blue-700 my-0" id="extra">
								<a class="text-white" href="#extra">Extra</a>
							</h3>

							<p>
							This section specifies any extra steps to take after Kernel compilation, that do not depend on the script.
							Using the script, it won't be necessary to execute <code>dracut</code> nor <code>grub</code> manually,
							because they'll be automatically executed.
							</p>

							<div class="divider"></div>

							<h4 class="tag tag--md bg-blue-700 mb-0" id="e-v4l2">
								<a class="text-white" href="#e-v4l2">V4L2loopback</a>
							</h4>

							<p>
							The script will automatically install this module for the compiled Kernel version.
							The only step you need to take is add the module settings, because the script
							does not check whether they exist or not.
							</p>

							<p>
							Modify <code>/etc/modprobe.d/v4l2loopback.conf</code>, and add the following:

							<pre class="mb-2"><code>options v4l2loopback exclusive_caps=1 card_label="Camera2"</code></pre>

							Here you can modify <code>card_label</code> to set the device name,
							whenever necessary, for example if you want to hide the fact this is a virtual device,
							or if you simply would like a better name.
							</p>

							<div class="divider"></div>

							<h4 class="tag tag--md bg-blue-700 mb-0" id="e-initramfs">
								<a class="text-white" href="#e-initramfs">Initramfs</a>
							</h4>

							<p>
							To run the Kernel an initramfs is necessary. To generate it, I'll use dracut.

							First of all, make sure you configured dracut.
							For example, here's my <code>/etc/dracut.conf</code>:

							<pre><code># Equivalent to -H
hostonly="yes"

# Add various modules
# Module                Description
# base                  include basic utilities
# bash					include /bin/bash as /bin/sh
# fs-lib                include filesystem tools like mount
# kernel-modules        include kernel modules
# rescue				include various utils for rescue mode
# resume                allow initramfs to resume from low-power state
# rootfs-block          mount block device that contains rootfs
# shutdown              set up hooks to run on shutdown
# udev-rules            include udev and some basic rules
# uefi-lib				include UEFI tools
# usrmount              mount /usr
dracutmodules+=" base bash fs-lib kernel-modules rescue resume rootfs-block shutdown udev-rules uefi-lib usrmount "

# Include elogind
install_items="/lib64/elogind/elogind-uaccess-command"

# Use lz4 to compress the initramfs
compress="lz4"

# Add early microcode loading
early_microcode="yes"
							</code></pre>
							</p>

							<p>
							It's sufficient to execute the following command as root:

							<pre class="mb-2"><code>dracut --kver 6.8.2-gentoo -f</code></pre>

							Replace <code>6.8.2-gentoo</code> whenever the Kernel version is different.
							Be careful to the <code>-f</code> flag, that forces the initramfs regeneration,
							even if it already exists for the chosen Kernel.

							The initramfs will be available under <code>/boot</code>,
							together with the previously compiled Kernel's files.
							</p>

							<div class="divider"></div>

							<h4 class="tag tag--md bg-blue-700 mb-0" id="e-bootloader">
								<a class="text-white" href="#e-bootloader">Bootloader</a>
							</h4>

							<p>
							To boot our new Kernel, we need to configure the bootloader.
							In this section, I'll only talk about GRUB2.

							Most users, at this point, will surely already have a working system,
							and a configured bootloader. This fact allows us to just
							update the bootloader config, without modifying any other files.

							So, you just need to run as root:

							<pre class="mb-2"><code>grub-mkconfig -o /boot/grub/grub.cfg</code></pre>

							This command will tell us the available Kernels (and any other OS),
							that will be available once we reboot our system,
							in addition to telling us which microcode(s) were found.
							</p>
						</div>
					</div>
				</div>

				<div class="mt-8">
					<a href="index.html">&larr; Go back to the main page</a>
				</div>
			</div>
		</div>
	</div>

	<!-- Footer -->
	<footer class="footer bg-blue-700 px-4 pt-6 pb-4 u-shadow-inset">
		<h5 class="title text-white pt-2">Matteo Salonia</h5>

		<a class="font-bold text-blue-700 p-2 tag" href="https://salonia.it/it/">IT</a>
		<a class="font-bold text-blue-700 p-2 tag" href="https://salonia.it/en/">EN</a>

		<p class="text-white mt-4 mb-0">&copy; 2022-2024</p>
	</footer>
</body>
</html>
