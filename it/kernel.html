<!DOCTYPE html>
<html lang="it">
<head>
	<title>Kernel &mdash; Matteo Salonia</title>

	<!-- Optimize page loading -->
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<!-- SEO -->
	<meta name="description"				content="Il Kernel personalizzato di Salonia Matteo.">
	<meta property="og:description"			content="Il Kernel personalizzato di Salonia Matteo.">
	<meta property="twitter:description"	content="Il Kernel personalizzato di Salonia Matteo.">
	<meta property="og:title"				content="Kernel &mdash; Matteo Salonia">
	<meta property="twitter:title"			content="Kernel &mdash; Matteo Salonia">
	<meta property="og:url"					content="https://salonia.it/it/kernel.html">
	<meta property="og:image"				content="https://salonia.it/favicon.png">
	<meta property="twitter:image"			content="https://salonia.it/favicon.png">

	<!-- Favicon -->
	<link rel="shortcut icon" href="../favicon.png">

	<!-- CSS & Fonts -->
	<link rel="stylesheet" href="../css/cirrus.min.css">
	<link rel="stylesheet" href="../css/fonts/montserrat.css">
</head>

<body>
	<!-- Header -->
	<div class="header header-fixed unselectable">
		<div class="header-brand u-center">
			<a href="https://salonia.it">
				<img class="w-24" src="../pics/salonia.png" alt="Logo">
			</a>
		</div>
	</div>

	<!-- Kernel -->
	<div class="hero u-text-center u-shadow-inset pt-8">
		<div class="hero-body m-2-sm">
			<div class="content w-90p w-80p-md">
			<h2 class="headline-4 text-gray-900">Kernel</h2>
				<p class="lead">
					In questa pagina sono contenuti tutti i dettagli per usare al meglio il mio
					script per configurare il Kernel Linux, ottimizzandolo per usufruire delle
					migliori prestazioni per il vostro hardware, ed essere il più leggero possibile.
				</p>

				<p>
				Vai a:<br>
				<a class="tag bg-blue-700 text-white" href="#intro">Introduzione</a>
				<a class="tag bg-blue-700 text-white" href="#setup">Setup</a>
				<a class="tag bg-blue-700 text-white" href="#extra">Extra</a>
				</p>

				<div class="content u-text-left">
					<div class="card">
						<div class="m-3">
							<!-- Intro -->
							<h3 class="tag tag--xl bg-blue-700 my-0" id="intro">
								<a class="text-white" href="#intro">Introduzione</a>
							</h3>

							<p>
							Questo progetto è stato realizzato e viene mantenuto per essere un "utensile",
							in grado di aiutarmi a configurare il Kernel come mi pare e piace,
							permettendomi anche di applicare delle patch in grado di renderlo più efficiente e performante,
							ottimizzando il Kernel per l'hardware presente, nei minimi dettagli.
							</p>

							<p>
							I miei setup si basano su un sistema composto dai seguenti componenti:
							<ul>
								<li><b>Distro</b>: <a class="link u u-LR" href="https://gentoo.org">Gentoo Linux</a></li>
								<li><b>Compressione Kernel</b>: LZ4 per initramfs, zstd per moduli</li>
								<li><b>Initramfs</b>: <a class="link u u-LR" href="https://github.com/dracutdevs/dracut">dracut</a></li>
								<li><b>Bootloader</b>: <a class="link u u-LR" href="https://www.gnu.org/software/grub/">GRUB</a></li>
								<li><b>Init</b>: <a class="link u u-LR" href="https://github.com/OpenRC/openrc">OpenRC</a></li>
								<li><b>Filesystem</b>:
									FAT32 per <a class="link u u-LR" href="https://en.wikipedia.org/wiki/EFI_system_partition">ESP</a>,
									XFS per <a class="link u u-LR" href="https://www.kernel.org/doc/html/latest/filesystems/ramfs-rootfs-initramfs.html#what-is-rootfs">rootfs</a>,
									ext4 per varie.</li>
								<li><b>logind</b>: <a class="link u u-LR" href="https://wiki.gentoo.org/wiki/Elogind">elogind</a></li>
							</ul>
							</p>

							<div class="card bg-warning">
								<p class="m-3">
								<b>Nota bene</b>: dato che uso <b>Gentoo</b>, i nomi dei pacchetti potrebbero essere diversi dai nomi
								dei pacchetti che usa la vostra distro (Arch, Debian, Fedora, ...). Siete pregati di verificare
								qualora i nomi fossero diversi, e di annotarli per procedere con questa guida.
								</p>
							</div>

							<p>
							Vi sono due configurazioni di default:
							<ol>
								<li>
									<code>config</code>: per il mio <b>ThinkPad T440p</b>, con CPU <b>i7-4700MQ</b>, nessuna GPU (iGPU),
									<b>8GB RAM</b>, SSD M.2 2242 + SSD SATAIII.
								</li>
								<li>
									<code>config.pc</code>: per il mio PC fisso, con CPU <b>i5-11400MQ</b>, nessuna GPU (iGPU),
									<b>16GB RAM</b>, SSD NVME Samsung 980 Pro</b>.
								</li>
							</ol>
							</p>

							<p>
							Dati i cambiamenti effettuati nella configurazione del Kernel, sarà necessario verificare che i componenti
							desiderati sono abilitati nel Kernel, qualora sceglieste la mia configurazione come punto di partenza.
							Ad esempio, componenti relativi ad AMD, Nvidia, NUMA, ecc. sono stati disabilitati.
							<br>
							Se non sapete dove partire, usate una configurazione già esistente che sapete funzioni sul vostro hardware,
							se disponibile, altrimenti usate la configurazione di default di un qualsiasi Kernel,
							come quella fornita dalla vostra distro, o la configurazione di default del Kernel.
							</p>
						</div>
					</div>

					<div class="card">
						<div class="m-3">
							<h3 class="tag tag--xl bg-blue-700 my-0" id="setup">
								<a class="text-white" href="#setup">Setup</a>
							</h3>

							<p>
							Assicuratevi di avere tutti gli strumenti necessari per poter proseguire.
							Verificate di avere <code>git</code>, <code>gcc</code>, <code>make</code>, ecc.
							Tipicamente, la maggior parte di strumenti per la compilazione
							viene fornita da pacchetti come <code>base-devel</code>.
							Consiglio di verificare anche la presenza di <code>linux-firmware</code>,
							in modo tale da avere i necessari firmware per eventuali componentistiche
							<a class="link u u-LR" href="https://www.gnu.org/philosophy/free-hardware-designs.html">nonfree</a>.
							Non dimenticate di scaricare il <a class="link u u-LR" href="https://wiki.gentoo.org/wiki/Microcode">microcode</a>
							adatto, che sia Intel, AMD, o altro.
							Infine, verificate la presenza di <code>lz4</code> e <code>zstd</code>,
							per la compressione di vari componenti del Kernel.
							</p>

							<div class="divider"></div>

							<h4 class="tag tag--md bg-blue-700 mb-0" id="s1">
								<a class="text-white" href="#s1">1. Ottenimento repository</a>
							</h4>

							<p>
							Useremo la directory <code>/usr/src/usr-kernel</code> per salvare
							questo progetto, e tutte le eventuali modifiche.
							<br>
							Assicuratevi di avere permessi di lettura e scrittura, in modo tale
							da poter creare la directory.
							</p>

							<pre><code>git clone --recurse-submodules "https://github.com/saloniamatteo/kernel" /usr/src/usr-kernel
cd /usr/src/usr-kernel</code></pre>

							<br>

							<div class="card bg-info text-white">
								<p class="m-3">
								Qualora la directory scelta dovesse essere diversa,
								non dimenticatevi di modificare la variabile <code>CUSTDIR</code> nel file <code>build.sh</code>.
								</p>
							</div>

							<div class="divider"></div>

							<h4 class="tag tag--md bg-blue-700 mb-0" id="s2">
								<a class="text-white" href="#s2">2. Selezione versione</a>
							</h4>

							<p>
							Una volta scaricata la repository, scegliete una versione disponibile.
							Per vedere quali versioni sono disponibili, basta vedere i contenuti della directory con <code>ls</code>.
							In questo esempio, utilizzeremo Linux <code>6.8.2-gentoo</code>.
							</p>

							<div class="card bg-info text-white">
								<p class="m-3">
								Il vostro Kernel sicuramente avrà una versione diversa.
								<br>
								Niente panico: basterà copiare la cartella, e rinominarla in base alla vostra versione.
								Ad esempio, se la vostra versione dovesse essere <code>6.8.3-zen</code>,
								basterà eseguire: <code>cp -r 6.8.2-gentoo 6.8.3-zen</code>.
								<br>
								Non dimenticatevi di modificare la variabile <code>KVER</code> qualora la versione
								primaria dovesse essere diversa (esempio: <code>6.8.2</code> -> <code>6.8.3</code>), e la variabile
								<code>PVER</code> qualora la versione secondaria dovesse essere diversa
								(esempio: <code>gentoo</code> -> <code>zen</code>)
								</p>
							</div>

							<div class="divider"></div>

							<h4 class="tag tag--md bg-blue-700 mb-0" id="s3">
								<a class="text-white" href="#s3">3. Modifica script</a>
							</h4>

							<p>
							A questo punto, non ci resta che verificare il contenuto di <code>build.sh</code>.
							Modifichiamo il file con qualsiasi editor di testo, e osserviamo le seguenti variabili:

							<ul>
								<li>
									<code>ARCHVER</code>: codice architettura processore, per ottimizzare il Kernel.
									Ecco la lista completa di codici:
									<pre class="my-2"><code> 1. AMD Opteron/Athlon64/Hammer/K8 (MK8)
 2. AMD Opteron/Athlon64/Hammer/K8 with SSE3 (MK8SSE3)
 3. AMD 61xx/7x50/PhenomX3/X4/II/K10 (MK10)
 4. AMD Barcelona (MBARCELONA)
 5. AMD Bobcat (MBOBCAT)
 6. AMD Jaguar (MJAGUAR)
 7. AMD Bulldozer (MBULLDOZER)
 8. AMD Piledriver (MPILEDRIVER)
 9. AMD Steamroller (MSTEAMROLLER)
10. AMD Excavator (MEXCAVATOR)
11. AMD Zen (MZEN)
12. AMD Zen 2 (MZEN2)
13. AMD Zen 3 (MZEN3)
14. AMD Zen 4 (MZEN4)
15. Intel P4 / older Netburst based Xeon (MPSC)
16. Intel Core 2 (MCORE2)
17. Intel Atom (MATOM)
18. Intel Nehalem (MNEHALEM)
19. Intel Westmere (MWESTMERE)
20. Intel Silvermont (MSILVERMONT)
21. Intel Goldmont (MGOLDMONT)
22. Intel Goldmont Plus (MGOLDMONTPLUS)
23. Intel Sandy Bridge (MSANDYBRIDGE)
24. Intel Ivy Bridge (MIVYBRIDGE)
25. Intel Haswell (MHASWELL)
26. Intel Broadwell (MBROADWELL)
27. Intel Skylake (MSKYLAKE)
28. Intel Skylake X (MSKYLAKEX)
29. Intel Cannon Lake (MCANNONLAKE)
30. Intel Ice Lake (MICELAKE)
31. Intel Cascade Lake (MCASCADELAKE)
32. Intel Cooper Lake (MCOOPERLAKE)
33. Intel Tiger Lake (MTIGERLAKE)
34. Intel Sapphire Rapids (MSAPPHIRERAPIDS)
35. Intel Rocket Lake (MROCKETLAKE)
36. Intel Alder Lake (MALDERLAKE)
37. Intel Raptor Lake (MRAPTORLAKE)
38. Intel Meteor Lake (MMETEORLAKE)
39. Intel Emerald Rapids (MEMERALDRAPIDS)
40. Generic-x86-64 (GENERIC_CPU)
41. Generic-x86-64-v2 (GENERIC_CPU2)
42. Generic-x86-64-v3 (GENERIC_CPU3)
43. Generic-x86-64-v4 (GENERIC_CPU4)
44. Intel-Native optimizations autodetected by GCC (MNATIVE_INTEL)
45. AMD-Native optimizations autodetected by GCC (MNATIVE_AMD)</code></pre>
								</li>
								<li><code>CONFIGFILE</code>: il nome del file di configurazione, che verrà copiato dalla directory al Kernel.</li>
								<li><code>JOBS</code>: quanti thread usare per la compilazione. Si consiglia di impostare al numero di core.</li>
								<li><code>KVER</code>: versione primaria Kernel.</li>
								<li><code>PVER</code>: versione secondaria/personalizzata Kernel.</li>
								<li><code>KERNVER</code>: versione completa Kernel, <u>non modificare</u>.</li>
								<li><code>CUSTDIR</code>: directory che contiene questo progetto, da modificare qualora sia diversa dai default.</li>
								<li><code>CLEARDIR</code>: nome directory patch Clear Linux, <u>non modificare</u>.</li>
								<li><code>PATCHDIR</code>: nome directory patch, <u>non modificare</u>.</li>
								<li><code>V4L2DIR</code>: nome directory V4L2loopback, <u>non modificare</u>.</li>
								<li><code>CFODIR</code>: nome directory Kernel Compiler Patch, <u>non modificare</u>.</li>
								<li><code>USRDIR</code>: directory che contiene la versione scelta del Kernel, <u>non modificare</u>.</li>
								<li><code>KERNELDIR</code>: questa variabile va impostata qualora la directory del Kernel sia diversa da <code>/usr/src</code>.</li>
							</ul>
							</p>

							<div class="divider"></div>

							<h4 class="tag tag--md bg-blue-700 mb-0" id="s4">
								<a class="text-white" href="#s4">4. Selezione flag</a>
							</h4>

							<p>
							Dopo aver modificato <code>build.sh</code>, bisogna selezionare i necessari parametri
							per poter stabilire quali azioni intraprendere.
							<br>
							Segue ora una tabella con tutti i vari parametri (flag).
							</p>

							<div class="table-container">
								<table class="table bordered striped">
									<thead class="bg-blue-700 text-white">
										<tr>
											<th>Flag breve</th>
											<th>Flag esteso</th>
											<th class="u-align-middle">Descrizione</th>
										</tr>
									</thead>
									
									<tbody>
										<tr>
											<td>-b</td>
											<td>--skip-build</td>
											<td>Salta la compilazione del Kernel.</td>
										</tr>
										<tr>
											<td>-c</td>
											<td>--skip-cfg</td>
											<td>Non copiare il file di configurazione Kernel (<code>config</code>).</td>
										</tr>
										<tr>
											<td>-d</td>
											<td>--distcc</td>
											<td>
												Usa <a class="link u u-LR" href="https://www.distcc.org">distcc</a>
												per velocizzare la compilazione del Kernel.
											</td>
										</tr>
										<tr>
											<td>-e</td>
											<td>--ccache</td>
											<td>
												Usa <a class="link u u-LR" href="https://ccache.dev">ccache</a>
												per velocizzare la compilazione del Kernel.
											</td>
										</tr>
										<tr>
											<td>-f</td>
											<td>--fastmath</td>
											<td>Compila il Kernel con opzioni di matematica veloce non sicura (unsafe fast math).</td>
										</tr>
										<tr>
											<td>-h</td>
											<td>--help</td>
											<td>Mostra il menu&apos; di aiuto ed esci.</td>
										</tr>
										<tr>
											<td>-l</td>
											<td>--clearl-ps</td>
											<td>Applica le patch di Clear Linux.</td>
										</tr>
										<tr>
											<td>-m</td>
											<td>--menuconfig</td>
											<td>Esegui <code>make menuconfig</code> nella directory del Kernel ed esci senza compilare.</td>
										</tr>
										<tr>
											<td>-o</td>
											<td>--cpu-opts</td>
											<td>Compila il Kernel con le ottimizzazioni per la famiglia del processore.</td>
										</tr>
										<tr>
											<td>-p</td>
											<td>--patches</td>
											<td>Applica le patch utente.</td>
										</tr>
										<tr>
											<td>-v</td>
											<td>--v4l2</td>
											<td>Compila il modulo <a class="link u u-LR" href="https://github.com/umlaeute/v4l2loopback">v4l2loopback</a>.</td>
										</tr>
									</tbody>
								</table>
							</div>

							<div class="divider"></div>

							<h4 class="tag tag--md bg-blue-700 mb-0" id="s5">
								<a class="text-white" href="#s5">5. Configurazione Kernel</a>
							</h4>

							<p>
							Tipicamente, sarà necessario andare a configurare il Kernel, partendo da un file di configurazione.
							Per fare ciò, basterà eseguire il seguente comando come utente root:

							<pre class="mb-2"><code>./build.sh -l -m -o -p</pre></code>

							Questo ci permetterà di:

							<ul>
								<li><code>-l</code>: Applicare le patch di Clear Linux</li>
								<li><code>-m</code>: Configurare il Kernel, potendo partire da una configurazione già impostata, o caricarne
								una personalizzata da cui avere un punto di partenza </li>
								<li><code>-o</code>: Applicare le ottimizzazioni per la famiglia del processore</li>
								<li><code>-p</code>: Applicare le patch utente</li>
							</ul>

							Una volta terminato il processo di configurazione del Kernel, il nuovo file di configurazione
							sarà disponibile presso <code>/usr/src/linux/.config</code>
							(oppure sotto <code>$KERNELDIR/.config</code> qualora <code>KERNELDIR</code> fosse stato impostato).
							</p>

							<p>
							A questo punto bisognerà copiare il file <code>.config</code> dalla directory del Kernel
							alla directory attuale, per poi confrontare i due file e controllare eventuali cambiamenti.

							<pre><code>cp /usr/src/linux/.config config.new<br>diff -u config config.new | vim</code></pre>

							L'ultimo comando qui sopra esegue il comando <code>diff</code>, mostrando le differenze tra
							il nostro file di partenza <code>config</code> ed il nuovo file <code>config.new</code>,
							per poi mostrare il tutto con l'editor Vim. Ovviamente, bisogna modificare il nome
							del file <code>config</code> nel comando sopra qualora fosse necessario.
							</p>

							<p>
							Dopo aver verificato le eventuali differenze, sostituiamo il nostro file config
							con il file <code>config.new</code>, e passiamo alla vera e propria compilazione del Kernel.
							</p>

							<div class="divider"></div>

							<h4 class="tag tag--md bg-blue-700 mb-0" id="s6">
								<a class="text-white" href="#s6">6. Compilazione Kernel</a>
							</h4>

							<p>
							Dopo essere sicuri di avere tutto il necessario,
							è possibile compilare il Kernel con il seguente comando, eseguendolo come utente root:

							<pre class="mb-2"><code>./build.sh -f -l -o -p</code></pre>

							Notate la presenza ripetuta delle opzioni di patch (<code>-l</code>, <code>-o</code>, <code>-p</code>).
							Questo perchè lo script, in automatico, ripristina tutti i cambiamenti effettuati dalle patch presenti
							nella directory del Kernel, ove possibile, e rimuove gli eventuali file patch.
							Ho programmato lo script in questo modo in quanto mi capita spesso di dover ripristinare e rimuovere
							varie patch, soprattutto dopo molteplici compilazioni.
							</p>

							<p>
							È bene specificare che lo script ci mostrerà tutti gli eventuali errori di compilazione e non solo,
							in aggiunta al calcolo del tempo effettivo di compilazione, non considerando quindi patch ed altro.
							</p>

							<p>
							Al termine dell'esecuzione, lo script installerà il Kernel, eseguendo in automatico
							<code>dracut</code> per generare l'initramfs, ed aggiornerà <code>grub</code>,
							grazie ad <code>installkernel</code>, che tipicamente tutte le distro hanno.
							Se la vostra configurazione non prevede l'uso di dracut o di grub,
							verificate la configurazione di installkernel, sarà già impostato
							per usare quello che state usando attualmente.
							</p>
						</div>
					</div>

					<div class="card">
						<div class="m-3">
							<h3 class="tag tag--xl bg-blue-700 my-0" id="extra">
								<a class="text-white" href="#extra">Extra</a>
							</h3>

							<p>
							Questa sezione specifica gli eventuali passaggi da effettuare dopo aver terminato la compilazione
							del Kernel, che non dipendono dallo script. Usando lo script, non sarà necessario eseguire
							nè <code>dracut</code> nè <code>grub</code> manualmente, perchè verranno eseguiti in automatico.
							</p>

							<div class="divider"></div>

							<h4 class="tag tag--md bg-blue-700 mb-0" id="e-v4l2">
								<a class="text-white" href="#e-v4l2">V4L2loopback</a>
							</h4>

							<p>
							Lo script andrà in automatico ad installare questo modulo per la versione del Kernel compilata.
							L'unico passaggio da effettuare è aggiungere le impostazioni del modulo,
							in quanto lo script non controlla se sono già presenti o meno.
							</p>

							<p>
							Modificate il file <code>/etc/modprobe.d/v4l2loopback.conf</code>, ed inserite il
							seguente contenuto:

							<pre class="mb-2"><code>options v4l2loopback exclusive_caps=1 card_label="Camera2"</code></pre>

							Qui potete modificare <code>card_label</code> per impostare il nome del dispositivo,
							qualora fosse necessario, ad esempio se si volesse mascherare il fatto che questo è
							un dispositivo virtuale, o se semplicemente volete un nome migliore.
							</p>

							<div class="divider"></div>

							<h4 class="tag tag--md bg-blue-700 mb-0" id="e-initramfs">
								<a class="text-white" href="#e-initramfs">Initramfs</a>
							</h4>

							<p>
							Per avviare il Kernel è necessario un initramfs. Per generarlo, userò dracut.
							
							Prima di tutto, accertatevi di aver configurato dracut.
							Ad esempio, ecco il mio <code>/etc/dracut.conf</code>:

							<pre><code># Equivalent to -H
hostonly="yes"

# Add various modules
# Module                Description
# base                  include basic utilities
# bash					include /bin/bash as /bin/sh
# fs-lib                include filesystem tools like mount
# kernel-modules        include kernel modules
# rescue				include various utils for rescue mode
# resume                allow initramfs to resume from low-power state
# rootfs-block          mount block device that contains rootfs
# shutdown              set up hooks to run on shutdown
# udev-rules            include udev and some basic rules
# uefi-lib				include UEFI tools
# usrmount              mount /usr
dracutmodules+=" base bash fs-lib kernel-modules rescue resume rootfs-block shutdown udev-rules uefi-lib usrmount "

# Include elogind
install_items="/lib64/elogind/elogind-uaccess-command"

# Use lz4 to compress the initramfs
compress="lz4"

# Add early microcode loading
early_microcode="yes"
							</code></pre>
							</p>

							<p>
							È sufficiente eseguire, come utente root, il seguente comando:

							<pre class="mb-2"><code>dracut --kver 6.8.2-gentoo -f</code></pre>

							Modificate <code>6.8.2-gentoo</code> qualora non fosse la versione del Kernel interessata.
							Attenzione al flag <code>-f</code>, che forza la rigenerazione dell'initramfs
							anche se già esiste per la versione del Kernel interessata.

							Fatto ciò, l'initramfs sarà disponibile sotto <code>/boot</code>,
							insieme ai file del Kernel precedentemente compilato.
							</p>

							<div class="divider"></div>

							<h4 class="tag tag--md bg-blue-700 mb-0" id="e-bootloader">
								<a class="text-white" href="#e-bootloader">Bootloader</a>
							</h4>

							<p>
							Per avviare il nostro nuovo Kernel, sarà necessario configurare il bootloader.
							In questa sezione, sarà trattato esclusivamente GRUB2.

							La maggior parte degli utenti, arrivati a questo punto, sicuramente avranno già un sistema
							funzionante, ed un bootloader configurato. Questo fatto ci allevia il carico,
							richiedendo semplicemente un aggiornamento della configurazione,
							senza modificare ulteriori file.

							Perciò, è necessario eseguire come utente root:

							<pre class="mb-2"><code>grub-mkconfig -o /boot/grub/grub.cfg</code></pre>

							Il comando ci comunicherà i Kernel (ed eventuali altri sistemi operativi) trovati,
							che saranno disponibili al riavvio del nostro sistema,
							oltre a comunicarci i microcode trovati.
							</p>
						</div>
					</div>
				</div>

				<div class="mt-8">
					<a href="index.html">&larr; Torna alla pagina principale</a>
				</div>
			</div>
		</div>
	</div>

	<!-- Footer -->
	<footer class="footer bg-blue-700 px-4 pt-6 pb-4 u-shadow-inset">
		<h5 class="title text-white pt-2">Matteo Salonia</h5>

		<a class="font-bold text-blue-700 p-2 tag" href="https://salonia.it/it/">IT</a>
		<a class="font-bold text-blue-700 p-2 tag" href="https://salonia.it/en/">EN</a>

		<p class="text-white mt-4 mb-0">&copy; 2022-2024</p>
	</footer>
</body>
</html>
